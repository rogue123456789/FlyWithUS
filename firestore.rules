/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * There are two primary roles: "Admin" and "Open User". A user's role is determined by the existence of their
 * UID as a document in the `/roles_admin` or `/roles_open` collections, respectively. Admins have full control
 * over all data. Open Users can read and write operational data (flights, fuel, work logs) as needed for daily
 * tasks on a shared device, but cannot perform administrative actions like deleting employees or aircraft.
 *
 * Data Structure:
 * - /employees, /aircrafts, /flight_logs, /fuel_records, /work_logs: Top-level collections for business data.
 * - /roles_admin, /roles_open: Collections used for role management. The existence of a document grants the role.
 *
 * Key Security Decisions:
 * - Admin Supremacy: Users with the 'Admin' role can read and write all data across the application.
 * - Open User Write Access: To support a shared "kiosk" mode, 'Open Users' are granted write access
 *   to operational collections like `flight_logs`, `fuel_records`, and `work_logs`. They can also update
 *   employee statuses (for clocking in/out) and aircraft hours.
 * - Destructive Action Protection: Creation and deletion of core assets like `employees` and `aircrafts` are
 *   restricted to Admins to prevent accidental data loss from the shared account.
 * - Role Management Security: The role collections (`/roles_admin`, `/roles_open`) can only be modified by
 *   existing Admins (with an exception for a user creating their own 'open' role), preventing users from
 *   escalating their own privileges.
 * - Default Deny: Access is implicitly denied unless explicitly granted by a rule.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the authenticated user has the 'Admin' role.
     * Role is granted if a document with the user's UID exists in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the authenticated user has the 'Open User' role.
     * Role is granted if a document with the user's UID exists in the /roles_open collection.
     */
    function isOpenUser() {
      return exists(/databases/$(database)/documents/roles_open/$(request.auth.uid));
    }
    
    /**
     * Checks if the authenticated user is the owner of a resource, based on a provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * A simple check to ensure a document exists before an update or delete operation.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * @description Manages employee profile data. Readable by all authenticated users.
     * Admins can create/delete. Admins and Open Users can update (for clock-in/out).
     */
    match /employees/{employeeId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || isOpenUser();
    }

    /**
     * @description Manages work log entries for all employees. 
     * Writable by Admins and Open Users.
     */
    match /work_logs/{workLogId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow write: if isAdmin() || isOpenUser(); // create, update, delete
    }

    /**
     * @description Stores information about aircraft. Readable by all.
     * Admins can create/delete. Admins and Open Users can create/update (for flight hours).
     */
    match /aircrafts/{aircraftId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow create, update: if isAdmin() || isOpenUser();
      allow delete: if isAdmin();
    }

    /**
     * @description Stores flight logs. 
     * Writable by Admins and Open Users.
     */
    match /flight_logs/{flightLogId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow write: if isAdmin() || isOpenUser(); // create, update, delete
    }

    /**
     * @description Stores fuel consumption records.
     * Writable by Admins and Open Users.
     */
    match /fuel_records/{fuelRecordId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow write: if isAdmin() || isOpenUser(); // create, update, delete
    }
    
    /**
     * @description Manages machine/vehicle logbooks.
     */
    match /logbooks/{logbookId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow create, update: if isAdmin() || isOpenUser();
      allow delete: if isAdmin();
    }

    /**
     * @description Stores logbook entries.
     */
    match /logbook_entries/{logbookEntryId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow write: if isAdmin() || isOpenUser(); // create, update, delete
    }
    
    /**
     * @description Manages payment records.
     */
    match /payments/{paymentId} {
      allow get, list: if isAdmin() || isOpenUser();
      allow write: if isAdmin() || isOpenUser(); // create, update, delete
    }

    /**
     * @description Manages which users have Admin privileges. Only other Admins can modify this collection. Users can read their own admin status.
     * @path /roles_admin/{adminUserId}
     */
    match /roles_admin/{adminUserId} {
      allow get: if isOwner(adminUserId);
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages which users have Open User privileges. Only Admins can create new roles, but users can create their own role on signup.
     * @path /roles_open/{openUserId}
     */
    match /roles_open/{openUserId} {
      allow get: if isOwner(openUserId);
      allow list: if isAdmin();
      allow create: if isOwner(openUserId) || isAdmin();
      allow update: if isAdmin() || isOwner(openUserId);
      allow delete: if isAdmin();
    }
  }
}
