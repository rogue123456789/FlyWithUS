/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model combined with user ownership.
 * There are two primary roles: "Admin" and "Open User". A user's role is determined by the existence of their
 * UID as a document in the `/roles_admin` or `/roles_open` collections, respectively. Admins have full control
 * over all data. Open Users have read-only access to public data like aircraft and flight logs. All other
 * authenticated users (employees) can only manage their own user-specific data.
 *
 * Data Structure:
 * - /users/{userId}/...: Private, user-owned data (e.g., time entries).
 * - /employees, /aircrafts, /flight_logs, /fuel_records: Top-level collections for business data, managed by Admins.
 * - /roles_admin, /roles_open: Collections used for role management. The existence of a document grants the role.
 *
 * Key Security Decisions:
 * - Admin Supremacy: Users with the 'Admin' role can read and write all data across the application.
 * - Open User Read Access: Users with the 'Open User' role are granted read-only access to non-sensitive
 *   collections like `aircrafts`, `flight_logs`, and `fuel_records`. They cannot view employee PII.
 * - User Data Ownership: User-specific data (e.g., `/users/{userId}/time_entries`) is strictly owned. Only the
 *   document owner or an Admin can access it.
 * - Role Management Security: The role collections (`/roles_admin`, `/roles_open`) can only be modified by
 *   existing Admins, preventing users from escalating their own privileges.
 * - Default Deny: Access is implicitly denied unless explicitly granted by a rule.
 *
 * Denormalization for Authorization: Roles are managed by the existence of documents in `/roles_admin/{uid}` and
 * `/roles_open/{uid}`. This allows for fast, efficient role checks using `exists()` without needing to read a user
 * profile document, simplifying rules and improving performance.
 *
 * Structural Segregation: User-specific data (`time_entries`) is segregated under a `/users/{userId}` path,
 * cleanly separating it from global, admin-managed data. Role documents are also in their own dedicated collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the authenticated user has the 'Admin' role.
     * Role is granted if a document with the user's UID exists in the /roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the authenticated user has the 'Open User' role.
     * Role is granted if a document with the user's UID exists in the /roles_open collection.
     */
    function isOpenUser() {
      return exists(/databases/$(database)/documents/roles_open/$(request.auth.uid));
    }
    
    /**
     * Checks if the authenticated user is the owner of a resource, based on a provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * A simple check to ensure a document exists before an update or delete operation.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * @description Manages employee profile data. This collection is for internal use and is fully controlled by Admins.
     * @path /employees/{employeeId}
     */
    match /employees/{employeeId} {
      allow read, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Manages work log entries for all employees. Fully controlled by Admins.
     * @path /work_logs/{workLogId}
     */
    match /work_logs/{workLogId} {
      allow read, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Stores information about aircraft. Writable only by Admins, but readable by Admins and Open Users.
     * @path /aircrafts/{aircraftId}
     */
    match /aircrafts/{aircraftId} {
      allow get: if isAdmin() || isOpenUser();
      allow list: if isAdmin() || isOpenUser();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Stores flight logs. Writable only by Admins, but readable by Admins and Open Users.
     * @path /flight_logs/{flightLogId}
     */
    match /flight_logs/{flightLogId} {
      allow get: if isAdmin() || isOpenUser();
      allow list: if isAdmin() || isOpenUser();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Stores fuel consumption records. Writable only by Admins, but readable by Admins and Open Users.
     * @path /fuel_records/{fuelRecordId}
     */
    match /fuel_records/{fuelRecordId} {
      allow get: if isAdmin() || isOpenUser();
      allow list: if isAdmin() || isOpenUser();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Manages which users have Admin privileges. Only other Admins can modify this collection. Users can read their own admin status.
     * @path /roles_admin/{adminUserId}
     */
    match /roles_admin/{adminUserId} {
      allow get: if isOwner(adminUserId);
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Manages which users have Open User privileges. Only Admins can create new roles, but users can create their own role on signup.
     * @path /roles_open/{openUserId}
     */
    match /roles_open/{openUserId} {
      allow get: if isOwner(openUserId);
      allow list: if isAdmin();
      allow create: if isOwner(openUserId) || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
